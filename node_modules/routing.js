var express = require('express');
var mysql = require('mysql');
var dateformat = require('dateformat');
var router = express.Router();
var passport = require('passport');
var cfg = require('config');
var mysqlhelper = require('mysqlhelper2');
var customerid;
var regcustomerid;

//fonction qui recupere le prix total par les prix passer en session
function total(req){
	console.log('*** Caddie - total calculating *** initialize the total price to 0');
	var total_prix = 0;
	if(typeof req.session.caddy == "undefined")
	{
		console.log('*** Caddie - total calculating *** No caddy in session - No calcul to make');
	}
	else
	{
		console.log('*** Caddie - total calculating *** Caddy in session - with items : ' +JSON.stringify(req.session.caddy));
		for(var i=0;i<req.session.caddy.length;i++)
		{
			console.log('*** Caddie - total calculating *** Caddy in session - order : ' +req.session.caddy[i].id+' on product with id '+ req.session.caddy[i].idproduct +' with price ' + req.session.caddy[i].price);
			total_prix = req.session.caddy[i].price + total_prix;
		}
		console.log('*** Caddie - total calculating *** Caddy in session - with total price : ' +total_prix);
	}
	console.log('*** Caddie - total calculating *** return the following total price ' + total_prix);
	return total_prix;
};


//route de la HP
router.get("/",function(req,resp){
	resp.redirect("index.html");
});


//route de HP avec BEST SALES

router.get("/index.html",function (req,resp){
	var sales;
	var newarrivals;
	var banners;
	mysqlhelper.pool.query('SELECT idproduct, SUM(quantity) AS SOMME, p.id, p.price,p.picture,p.label FROM ORDERS as o, PRODUCTS as p WHERE o.idproduct = p.id GROUP BY o.idproduct ORDER BY SOMME DESC LIMIT 3  ',function(err,rows,fields){
		sales=rows;	
		
		
		console.log('sales rows: '+JSON.stringify(rows));
		if(err != null)
		{
			console.log(message + ' ' + err);
		}
		
		else
		{
			console.log('query ok'+rows);
			
			mysqlhelper.pool.query('SELECT * FROM products ORDER BY id DESC LIMIT 5',function(err,rows){
				newarrivals=rows;
				console.log('new arrivals rows: '+JSON.stringify(rows));
				if(err != null)
				{
					console.log(message + ' ' + err);
				}
				else
				{
					console.log('query ok'+rows);
					mysqlhelper.pool.query('SELECT * FROM products WHERE rand()>0.1 ORDER BY rand() LIMIT 3',function(err,rows){
						console.log('banners rows: '+JSON.stringify(rows));
						banners=rows;
						if(err != null)
						{
							console.log(message + ' ' + err);
						}
						else
						{
							console.log('query ok'+rows);
						}	
						
					});
					
					if(typeof req.user !== 'undefined')
					{
						if(req.session.caddy){
							nbitem=req.session.caddy.length;
						}
						else{
							nbitem=0;
						}
						resp.render("index.html.twig",{"username":req.user.username,"nbitem":nbitem,"role":req.user.role,"newarrivals":newarrivals,"banners":banners,"list_new_arrivals":sales});
					}
					else
					{
						if(req.session.caddy){
							nbitem=req.session.caddy.length;
						}
						else{
							nbitem=0;
						}
						
						resp.render("index.html.twig",{"nbitem":nbitem,"newarrivals":newarrivals,"banners":banners,"list_new_arrivals":sales});
					}										
				}				
			});							
		}				
	});
});

//route de la page contact
router.get("/contact.html",function(req,resp){
	var tot= total(req);
	if(typeof req.user !== 'undefined')
	{
		if(req.session.caddy){
			nbitem=req.session.caddy.length;
		}
		else{
			nbitem=0;
		}
		resp.render("contact.html.twig",{"username":req.user.username,"nbitem":nbitem,"role":req.user.role,"total":tot});
	}
	else
	{
		if(req.session.caddy){
			nbitem=req.session.caddy.length;
		}
		else{
			nbitem=0;
		}
		resp.render("contact.html.twig",{"nbitem":nbitem,"total":tot});
	}
});

//route après l'envoi du formulaire de contact
router.post("/contact.html",function(req,resp){
	var tot= total(req);
	var message = '';
	//on recupere le nom dans la variable name
	var name = req.body.name;
	console.log("verifName avant f : "+name);	
	//fonction qui va verifier le nom
	function verifName(name){
		console.log("verifName : "+name+"length : "+name.length);
		
		if(name.length < 2 || name.length > 32){
			console.log("verifName false"+name);
			message = "Veuillez insérer un nom valide";
			return false;
		}
		else
		{
			console.log("verifName true"+name);
			return true;
		}
	}
	//on recupere l'email'dans la variable email
	var email = req.body.email;
	//fonction qui va verifier l'email
	function verifEmail(email){
			var regex = /^[a-zA-Z0-9._-]+@[a-z0-9._-]{2,}\.[a-z]{2,4}$/;
			console.log("verifemail : "+email);
			if(!regex.test(email))
			{
				console.log("verifemail false : "+email);
				message =message + " <br />Veuillez insérer un email valide";
				return false;
			}
			else
			{
				console.log("verifemail true : "+email);
				return true;
			}
	}
	var subject = req.body.subject;
	function verifsujet(subject){
		console.log("verifsubject : "+subject);
		if(subject.length < 2 || subject.length > 200 ){
			console.log("verifsubject false : "+subject);
			message = message + " <br />Veuillez remplir le sujet ";
			return false;
		}
		else
		{
			console.log("verifsubject true : "+subject);
			return true;
		}
		
	}

	var verifNameOk=verifName(name);
	var verifEmailOk=verifEmail(email);
	var verifsujetOk=verifsujet(subject);
	console.log("verifNameOk "+verifNameOk);
	console.log("verifEmailOk "+verifEmailOk);
	console.log("verifsujetOk "+verifsujetOk);



	if(verifNameOk && verifEmailOk && verifsujetOk){
		
			mysqlhelper.pool.query('INSERT INTO contact_form (id, name, email, subject, emailnotification) VALUES (NULL, "'+name+'", "'+email+'", "'+subject+'", 1)',function(err,rows,fields){
		if(err != null)
		{
			message = "Il y a eu une erreur, le message n'a pas été envoyé";
			console.log(message + ' ' + err);
		}
		else
		{
			message = "Votre message a bien été envoyé";
			console.log('message envoyé');
		}		
		
		if(typeof req.user !== 'undefined')
		{
			if(req.session.caddy){
				nbitem=req.session.caddy.length;
			}
			else{
				nbitem=0;
			}
			resp.render("contact.html.twig",{"username":req.user.username, "message":message,"nbitem":nbitem,"role":req.user.role,"total":tot});
		}
		else
		{
			if(req.session.caddy){
				nbitem=req.session.caddy.length;
			}
			else{
				nbitem=0;
			}
			message="Votre message a bien été envoyé ! ";
			console.log(message);
			resp.status(200).end(''+message);
		}
	});

	}
	else{
	console.log(message);
	resp.status(200).end(''+message);
	}
	


	console.log('Fin contact ----------------------------------');
	
});

//ROUTES DE REGISTER
//GET
router.get("/register.html",function (req,resp){
	var tot= total(req);
	if(req.session.caddy){
		nbitem=req.session.caddy.length;
	}
	else{
		nbitem=0;
	}
	resp.render("register.html.twig",{"nbitem":nbitem,"total":tot});	
});
//POST
//route de la page register
router.post("/register.html",function (req,resp){
var dbusers = [];
var emailusers = [];
	
	var username = req.body.username;
	var password = req.body.password;
	var nom = req.body.nom;
	var civility = req.body.civilite;
	var prenom = req.body.prenom;
	var email = req.body.email;
	var telephone = req.body.telephone;	
	
	var numerodom = req.body.numerodomicile;
	var ruedom = req.body.ruedomicile;
	var CPdom = req.body.CPdomicile;
	var villedom = req.body.villedomicile;
	
	var numerofact = req.body.numerofacturation;
	var ruefact = req.body.ruefacturation;
	var CPfact = req.body.CPfacturation;
	var villefact = req.body.villefacturation;
	
	var numerocour = req.body.numerocourrier;
	var ruecour = req.body.ruecourrier;
	var CPcour = req.body.CPcourrier;
	var villecour = req.body.villecourrier;
	
	var numerolivr = req.body.numerolivraison;
	var ruelivr = req.body.ruelivraison;
	var CPlivr = req.body.CPlivraison;
	var villelivr = req.body.villelivraison;
	
	var livraison = req.body.checkboxlivraison;
	var facturation = req.body.checkboxfacturation;
	var courrier = req.body.checkboxcourrier;
	
	var regEmail = /^[a-z0-9._-]+@[a-z0-9._-]{2,}\.[a-z]{2,4}$/;
	var regPassword = /^\w{4,64}$/;
	var regUsername = /^\w{2,25}$/;
	var regPrenom = /^[a-zA-Z \-àäâéèêëïîôöüùûüç]{2,32}$/;
	var regNom = /^[a-zA-Z \-àäâéèêëïîôöüùûüç]{2,64}$/;
	var regTel = /^\d{9}$/;
	var regNumeroDom = /^\w{1,16}$/;
	var regRueDom = /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,128}$/;
	var regCPDom = /^\d{5}$/;
	var regVilleDom = /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,32}$/;
	
	var regNumeroFact = /^\w{1,16}$/;
	var regRueFact = /^[a-zA-Z0-9 -\'àäâéèêëïîôöüùûüç]{2,128}$/;
	var regCPFact = /^\d{5}$/;
	var regVilleFact =  /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,32}$/;
	
	var regNumeroCour = /^\w{1,16}$/;
	var regRueCour = /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,128}$/;
	var regCPCour = /^\d{5}$/;
	var regVilleCour =  /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,32}$/;
	
	var regNumeroLivr = /^\w{1,16}$/;
	var regRueLivr = /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,128}$/;
	var regCPLivr = /^\d{5}$/;
	var regVilleLivr =  /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,32}$/;
	
	var messageerreur= [];

	if(typeof email !== 'undefined')
		if(!regEmail.test(email)){
			messageerreur.push('Email invalid');
		}
	if(!regPassword.test(password)){
		messageerreur.push('Password invalid');
	}
	if(!regUsername.test(username)){
		messageerreur.push('Username invalid');
	}
	if(!regPrenom.test(prenom)){
		messageerreur.push('Firstname invalid');
	}
	if(!regNom.test(nom)){
		messageerreur.push('Lastname invalid');
	}
	if(!regTel.test(telephone)){
		messageerreur.push('Phone invalid');
	}
	if(!regNumeroDom.test(numerodom)){
		messageerreur.push('Home number invalid');
	}
	if(!regRueDom.test(ruedom)){
		messageerreur.push('Street invalid');
	}
	if(!regCPDom.test(CPdom)){
		messageerreur.push('PC invalid');
	}
	if(!regVilleDom.test(villedom)){
		messageerreur.push('Town invalid');
	}
	if(facturation=='on')
	{
		if(!regNumeroFact.test(numerofact)){
			messageerreur.push('Facturation number invalid');
		}
		if(!regRueFact.test(ruefact)){
			messageerreur.push('Facturation Street invalid');
		}
		if(!regCPFact.test(CPfact)){
			messageerreur.push('Facturation PC invalid');
		}
		if(!regVilleFact.test(villefact)){
			messageerreur.push('Facturation Town invalid');
		}
	}
	if(courrier=='on')
	{
		if(!regNumeroCour.test(numerocour)){
			messageerreur.push('Courrier number invalid');
		}
		if(!regRueCour.test(ruecour)){
			messageerreur.push('Courrier Street invalid');
		}
		if(!regCPCour.test(CPcour)){
			messageerreur.push('Courrier PC invalid');
		}
		if(!regVilleCour.test(villecour)){
			messageerreur.push('Courrier Town invalid');
		}
	}
	if(livraison=='on')
	{
		if(!regNumeroLivr.test(numerolivr)){
			messageerreur.push('Delivery number invalid');
		}
		if(!regRueLivr.test(ruelivr)){
			messageerreur.push('Delivery Street invalid');
		}
		if(!regCPLivr.test(CPlivr)){
			messageerreur.push('Delivery PC invalid');
		}
		if(!regVilleLivr.test(villelivr)){
			messageerreur.push('Delivery Town invalid');
		}
	}	
	mysqlhelper.pool.query('SELECT username FROM app_users WHERE username="'+username+'" ',function(err,rows,fields){
		dbusers=rows;
		console.log('dbusers: '+JSON.stringify(dbusers));
		mysqlhelper.pool.query('SELECT email FROM app_users WHERE email="'+email+'"',function(err,rows,fields){
			emailusers=rows;
			console.log('emailusers: '+JSON.stringify(emailusers));
			if(dbusers.length !== 0 || emailusers.length !== 0)
			{
				messageerreur.push('Email or username already used');
				console.log('messageerreur: '+messageerreur);
				resp.status(200).end(''+messageerreur);
				return;
			}
			else
			{
				console.log('messageerreur: '+messageerreur);
				
				
				if(messageerreur.length == 0)
				{
					// 1 INSERT INTO user
					mysqlhelper.pool.query('INSERT INTO app_users(username, password, email) VALUES ("'+username+'","'+password+'" ,"'+email+'")',function(err,rows,fields){				
							if(err!=null)
							{
								console.log("Il y a eu une erreur INSERT INTO app_users" + err);
							}
							else
							{
								// 2 INSERT INTO customer
								mysqlhelper.pool.query('INSERT INTO customers(civility, lastname, firstname, email, phone) VALUES ("'+civility+'","'+nom+'","'+prenom+'","'+email+'","'+telephone+'")',function(err,rows,fields){				
									if(err!=null)
									{
										console.log("Il y a eu une erreur INSERT INTO customer" + err);
									}
									else
									{               
										// 3 insert des adresses
										mysqlhelper.pool.query('SELECT id FROM customers WHERE email="'+email+'"',function(err,rows,fields){
											for(i=0;i<rows.length;i++)
											{
												row = rows[i];
												console.log('row :'+row);
											}
											regcustomerid = row.id;
											console.log('regcustomerid: '+regcustomerid);
											
											mysqlhelper.pool.query('INSERT INTO addresses(num, street, pc, city, addresstype, idcustomer) VALUES ("'+numerodom+'","'+ruedom+'","'+CPdom+'","'+villedom+'","domicile","'+regcustomerid+'")',function(err,rows,fields){				
												if(err!=null)
												{
													console.log("Il y a eu une erreur INSERT INTO addresses" + err);
												}
												else
												{
													console.log('envoi INSERT INTO addresses ok');
												}
											});
												//insert bloc adresse courrier
												if(courrier=='on')
												{
													mysqlhelper.pool.query('INSERT INTO addresses(num, street, pc, city, addresstype, idcustomer) VALUES ("'+numerocour+'","'+ruecour+'","'+CPcour+'","'+villecour+'","courrier","'+regcustomerid+'")',function(err,rows,fields){
														if(err != null)
														{
															message = "Il y a eu une erreur dans le block courrier, le formulaire n'a pas été envoyé";
															console.log(message + ' ' + err);
														}
														else
														{
															console.log('query insert bloc courrier');
														}
													});
												}
												//insert bloc livraison 
												if(livraison=='on')
												{
													mysqlhelper.pool.query('INSERT INTO addresses(num, street, pc, city, addresstype, idcustomer) VALUES ("'+numerolivr+'","'+ruelivr+'","'+CPlivr+'","'+villelivr+'","livraison","'+regcustomerid+'")',function(err,rows,fields){
														if(err != null)
														{
															message = "Il y a eu une erreur dans le block livraison, le formulaire n'a pas été envoyé";
															console.log(message + ' ' + err);
														}
														else
														{
															console.log('query insert bloc livraison');
														}
													});
												}
												if(facturation=='on')
												{
													mysqlhelper.pool.query('INSERT INTO addresses(num, street, pc, city, addresstype, idcustomer) VALUES ("'+numerofact+'","'+ruefact+'","'+CPfact+'","'+villefact+'","facturation","'+regcustomerid+'")',function(err,rows,fields){
														if(err != null)
														{
															message = "Il y a eu une erreur dans le block facturation, le formulaire n'a pas été envoyé";
															console.log(message + ' ' + err);
														}
														else
														{
															console.log('query insert bloc facturation');
														}
													});
												}
										});
										console.log('envoi INSERT INTO customer ok');
									}
								});		
								console.log('envoi INSERT INTO app_users ok');
							}
						});
					resp.status(200).end('<span style="color: green;">Your account on eBoutique has now been created!</span>');
					return;
				}
				else
				{
					resp.status(200).end(''+messageerreur);
					console.log('test');
					return;
				}
			}
			
		});
	});
});		

//route de la page profil
router.get("/profil.html",function(req,resp){
	var profil;
	var adresses;
	var tot= total(req);

	if(typeof req.user !== 'undefined')
	{
		console.log('connection mysql profil form');
		mysqlhelper.pool.query('SELECT * FROM app_users, customers WHERE app_users.username = ? AND app_users.email = customers.email',[req.user.username],function(err,rows,fields){
			if(err != null)
			{
				console.log(err);
			}
			else
			{
				console.log('query profil ok');
				profil=rows;
				//select pour le bloc adresse
				mysqlhelper.pool.query('SELECT * FROM addresses WHERE idcustomer="'+profil[0].id+'"',function(err,rows,fields){
					if(err !=null)
					{
						console.log(err);
					}
					else
					{
						adresses=rows;
						console.log('query adresses ok');
					}	
					customerid = profil[0].id;
					console.log('customerid: '+customerid);
					console.log('var profil: '+JSON.stringify(profil));
					console.log('var adresses: '+JSON.stringify(adresses));
					if(req.session.caddy){
						nbitem=req.session.caddy.length;
					}
					else{
						nbitem=0;
					}
					resp.render("profil.html.twig",{"username":req.user.username,"allProfil":profil,"adresses":adresses,"nbitem":nbitem,"role":req.user.role,"total":tot});
				});			
			}		
		});	
	}
	else
	{
		resp.redirect("index.html");
	}
});

//route après l'envoi du formulaire de profil
router.post("/profil.html",function(req,resp){
	//var username = req.body.username;
	var password = req.body.password;
	var nom = req.body.nom;
	var civility = req.body.civilite;
	var prenom = req.body.prenom;
	var email = req.body.email;
	var telephone = req.body.telephone;
	
	var numerodom = req.body.numerodomicile;
	var ruedom = req.body.ruedomicile;
	var CPdom = req.body.CPdomicile;
	var villedom = req.body.villedomicile;
	
	var numerofact = req.body.numerofacturation;
	var ruefact = req.body.ruefacturation;
	var CPfact = req.body.CPfacturation;
	var villefact = req.body.villefacturation;
	
	var numerocour = req.body.numerocourrier;
	var ruecour = req.body.ruecourrier;
	var CPcour = req.body.CPcourrier;
	var villecour = req.body.villecourrier;
	
	var numerolivr = req.body.numerolivraison;
	var ruelivr = req.body.ruelivraison;
	var CPlivr = req.body.CPlivraison;
	var villelivr = req.body.villelivraison;
	
	var livraison = req.body.checkboxlivraison;
	var facturation = req.body.checkboxfacturation;
	var courrier = req.body.checkboxcourrier;
	
	var regEmail = /^[a-z0-9._-]+@[a-z0-9._-]{2,}\.[a-z]{2,4}$/;
	var regPassword = /^\w{4,64}$/;
	//var regUsername = /^\w{2,25}$/;
	var regPrenom = /^[a-zA-Z \-àäâéèêëïîôöüùûüç]{2,32}$/;
	var regNom = /^[a-zA-Z \-àäâéèêëïîôöüùûüç]{2,64}$/;
	var regTel = /^\d{9}$/;
	var regNumeroDom = /^\w{1,16}$/;
	var regRueDom = /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,128}$/;
	var regCPDom = /^\d{5}$/;
	var regVilleDom = /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,32}$/;
	
	var regNumeroFact = /^\w{1,16}$/;
	var regRueFact = /^[a-zA-Z0-9 -\'àäâéèêëïîôöüùûüç]{2,128}$/;
	var regCPFact = /^\d{5}$/;
	var regVilleFact =  /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,32}$/;
	
	var regNumeroCour = /^\w{1,16}$/;
	var regRueCour = /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,128}$/;
	var regCPCour = /^\d{5}$/;
	var regVilleCour =  /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,32}$/;
	
	var regNumeroLivr = /^\w{1,16}$/;
	var regRueLivr = /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,128}$/;
	var regCPLivr = /^\d{5}$/;
	var regVilleLivr =  /^[a-zA-Z0-9 \-'àäâéèêëïîôöüùûüç]{2,32}$/;
	
	var messageerreur= [];

	if(typeof email !== 'undefined')
		if(!regEmail.test(email)){
			messageerreur.push('Email invalid');
		}
	if(!regPassword.test(password)){
		messageerreur.push('Password invalid');
	}
	/*if(!regUsername.test(username)){
		messageerreur.push('Username invalid');
	}*/
	if(!regPrenom.test(prenom)){
		messageerreur.push('Firstname invalid');
	}
	if(!regNom.test(nom)){
		messageerreur.push('Lastname invalid');
	}
	if(!regTel.test(telephone)){
		messageerreur.push('Phone invalid');
	}
	if(!regNumeroDom.test(numerodom)){
		messageerreur.push('Home number invalid');
	}
	if(!regRueDom.test(ruedom)){
		messageerreur.push('Street invalid');
	}
	if(!regCPDom.test(CPdom)){
		messageerreur.push('PC invalid');
	}
	if(!regVilleDom.test(villedom)){
		messageerreur.push('Town invalid');
	}
	if(facturation=='on')
	{
		if(!regNumeroFact.test(numerofact)){
			messageerreur.push('Facturation number invalid');
		}
		if(!regRueFact.test(ruefact)){
			messageerreur.push('Facturation Street invalid');
		}
		if(!regCPFact.test(CPfact)){
			messageerreur.push('Facturation PC invalid');
		}
		if(!regVilleFact.test(villefact)){
			messageerreur.push('Facturation Town invalid');
		}
	}
	if(courrier=='on')
	{
		if(!regNumeroCour.test(numerocour)){
			messageerreur.push('Courrier number invalid');
		}
		if(!regRueCour.test(ruecour)){
			messageerreur.push('Courrier Street invalid');
		}
		if(!regCPCour.test(CPcour)){
			messageerreur.push('Courrier PC invalid');
		}
		if(!regVilleCour.test(villecour)){
			messageerreur.push('Courrier Town invalid');
		}
	}
	if(livraison=='on')
	{
		if(!regNumeroLivr.test(numerolivr)){
			messageerreur.push('Delivery number invalid');
		}
		if(!regRueLivr.test(ruelivr)){
			messageerreur.push('Delivery Street invalid');
		}
		if(!regCPLivr.test(CPlivr)){
			messageerreur.push('Delivery PC invalid');
		}
		if(!regVilleLivr.test(villelivr)){
			messageerreur.push('Delivery Town invalid');
		}
	}	
	
	console.log('le nom est : '+nom);
	console.log('connection mysql pour l\'envoi du profil form');
	
	if(messageerreur.length == 0){
	//update profil + bloc adresse domicile
		mysqlhelper.pool.query('UPDATE app_users, customers, addresses SET app_users.password=?, customers.civility=?, customers.lastname=?, customers.firstname=?, customers.phone=?, addresses.num=?, addresses.street=?, addresses.pc=?, addresses.city=? WHERE app_users.username = ? AND app_users.email = customers.email AND addresses.idcustomer = customers.id AND addresses.addresstype = "domicile"',[password,civility,nom,prenom,telephone,numerodom,ruedom,CPdom,villedom,req.user.username],function(err,rows,fields){
			if(err!=null)
			{
				message = "Il y a eu une erreur dans le formulaire, il n'a pas été envoyé";
				console.log(message + ' ' + err);
			}
			else
			{
				console.log('envoi du formulaire ok');
			}
			
		});
		console.log('etat box facturation: '+facturation);
		console.log('etat box courrier: '+courrier);
		console.log('etat box livraison: '+livraison);
		//update bloc facturation ou insert si adresse facturation non renseignée
		if(facturation=='on')
		{
			mysqlhelper.pool.query('SELECT * FROM addresses WHERE addresstype="facturation" AND idcustomer=?',[customerid],function(err,rows,fields){
				if(rows.length > 0)
				{
					mysqlhelper.pool.query('UPDATE addresses SET addresstype = "facturation", num=?, street=?, pc=?, city=?, idcustomer = ? WHERE addresses.addresstype = "facturation"',[numerofact,ruefact,CPfact,villefact,customerid],function(err,rows,fields){
						console.log('query update bloc facturation');
						console.log('customerid: '+customerid)
						});
				}
				else
				{
					mysqlhelper.pool.query('INSERT INTO addresses(num, street, pc, city, addresstype, idcustomer) VALUES (?,?,?,?,?,?)',[numerofact,ruefact,CPfact,villefact,facturation,customerid],function(err,rows,fields){
						if(err != null)
						{
							message = "Il y a eu une erreur dans le block facturation, le formulaire n'a pas été envoyé";
							console.log(message + ' ' + err);
						}
						else{
						console.log('query insert bloc facturation');
						}
					});
				}
				});	
		}
		//update du bloc courrier ou insert si adresse courrier non renseignée
		if(courrier=='on')
		{
			mysqlhelper.pool.query('SELECT * FROM addresses WHERE addresstype="courrier" AND idcustomer=?',[customerid],function(err,rows,fields){
				if(rows.length > 0)
				{
					mysqlhelper.pool.query('UPDATE addresses SET addresstype = "courrier", num=?", street=?, pc=?, city=?, idcustomer= ? WHERE addresses.addresstype = "courrier"',[numerocour,ruecour,CPcour,villecour,],function(err,rows,fields,customerid){
						console.log('query update bloc courrier');
					});
				}
				else
				{
					mysqlhelper.pool.query('INSERT INTO addresses(num, street, pc, city, addresstype, idcustomer) VALUES (?,?,?,?,"courrier",?)',[numerocour,ruecour,CPcour,villecour,customerid],function(err,rows,fields){
						if(err != null)
						{
							message = "Il y a eu une erreur dans le block courrier, le formulaire n'a pas été envoyé";
							console.log(message + ' ' + err);
						}
						else{
						console.log('query insert bloc courrier');
						}
					});
				}
			});
				
			
		}
		//update du bloc livraison ou insert si adresse livraison non renseignée
		if(livraison=='on')
		{
			mysqlhelper.pool.query('SELECT * FROM addresses WHERE addresstype="livraison" AND idcustomer="'+customerid+'"',function(err,rows,fields){
				if(rows.length > 0)
				{
					mysqlhelper.pool.query('UPDATE addresses SET addresstype = "livraison", num=?, street=?, pc=?, city=?, idcustomer = ? WHERE addresses.addresstype = "livraison"',[numerolivr,ruelivr,CPlivr,villelivr,customerid],function(err,rows,fields){
						console.log('query update bloc livraison');
					});
				}
				else
				{
					mysqlhelper.pool.query('INSERT INTO addresses(num, street, pc, city, addresstype, idcustomer) VALUES (?,?,?,?,"livraison",?)',[numerolivr,ruelivr,CPlivr,villelivr,customerid],function(err,rows,fields){
						if(err != null)
						{
							message = "Il y a eu une erreur dans le block livraison, le formulaire n'a pas été envoyé";
							console.log(message + ' ' + err);
						}
						else{
						console.log('query insert bloc livraison');
						}
					});
				}
			});
			
			
			
		}
		resp.status(200).end('<span style="color: green;">Your modifications have been set !</span>');
		return;
	}
	else
	{
		resp.status(200).end(''+messageerreur);
		console.log('test');
		return;
	}
});

//supprimer adresse
router.get("/supprimeradresse/:adresstype",function(req,resp){
	var adressetype = req.params.adresstype;
	if(typeof req.user !== 'undefined')
	{
		mysqlhelper.pool.query('DELETE FROM addresses WHERE addresstype = ? AND idcustomer=? ',[adressetype,customerid],function(err,rows,fields){
			console.log('query delete: '+adressetype);
		});
		resp.redirect("/profil.html");
	}
	else
	{
	resp.redirect("/index.html");
	}
});



//route de la page decor (liste de produits de la catégorie decor)
router.get("/decor.html",function(req,resp){
	if(typeof req.user !== 'undefined')
	{
		resp.render("index.html.twig",{"username":req.user.username,"nbitem":nbitem,"role":req.user.role});
	}
	else
	{
		
	resp.render("decor.html.twig",{"nbitem":nbitem});
	}
});
//route de la page health (liste de produits de la catégorie health)
router.get("/health.html",function(req,resp){
	if(typeof req.user !== 'undefined')
	{
		resp.render("health.html.twig",{"username":req.user.username,"nbitem":nbitem,"role":req.user.role});
	}
	else
	{
	resp.render("health.html.twig",{"nbitem":nbitem});
	}
});

//route de la page mobile (liste de produits de la catégorie mobile)
router.get("/mobile.html",function(req,resp){
	if(typeof req.user !== 'undefined')
	{
		resp.render("mobile.html.twig",{"username":req.user.username,"nbitem":nbitem,"role":req.user.role});
	}
	else
	{
	resp.render("mobile.html.twig",{"nbitem":nbitem});
	}
});
// route de la page products (liste de produits de la catégorie products)
//!!! refaire tourner CREATE TABLE.sql pour ajouter le chemin des images dans la table products!!!!!!!


router.get("/products.html",function (req,resp){
	var tot= total(req);
	mysqlhelper.pool.query('SELECT * FROM products WHERE products.deleted=0',function(err,rows,fields){
		if(err != null){
			console.log('*** Query SQL *** SELECT ALL PRODUCTS - Error *** '+err);												
		}else
			console.log('*** Query SQL *** SELECT ALL PRODUCTS - Success *** ');												
			if(typeof req.user !== 'undefined')
			{
				if(req.session.caddy){
					nbitem=req.session.caddy.length;
				}
				else{
					nbitem=0;
				}
				resp.render("products.html.twig",{"list_products":rows,"username":req.user.username,"nbitem":nbitem,"role":req.user.role,"total":tot});
			}
			else
			{
				if(req.session.caddy){
					nbitem=req.session.caddy.length;
				}
				else{
					nbitem=0;
				}
				resp.render("products.html.twig",{"list_products":rows,"nbitem":nbitem,"total":tot});
			}
	});
});

// route de la page single (détail du produit)

router.get("/single.html/:id", function (req,resp) {
	var id=req.params.id;
	var tot= total(req);
	mysqlhelper.pool.query('SELECT * FROM products WHERE products.id= ?',[id],function(err,rows,fields){
		if(err != null){
			console.log('*** Query SQL *** SELECT ONE PRODUCT - Error *** ' + err);												
		}else
			console.log('*** Query SQL *** SELECT ONE PRODUCT - Success *** ');												
			if(typeof req.user !== 'undefined')
			{
				if(req.session.caddy){
					nbitem=req.session.caddy.length;
				}
				else{
					nbitem=0;
				}
				resp.render("single.html.twig",{"products":rows,"username":req.user.username,"nbitem":nbitem,"role":req.user.role,"total":tot
				});
			}
			else
			{
				if(req.session.caddy){
					nbitem=req.session.caddy.length;
				}
				else{
					nbitem=0;
				}
				resp.render("single.html.twig",{"products":rows,"nbitem":nbitem,"total":tot 
				});
			}
	});
});

//route de la page 404
router.get("/404.html",function(req,resp){
	if(typeof req.user !== 'undefined')
	{
		
		resp.render("404.html.twig",{"username":req.user.username});
	}
	else
	{
		resp.render("404.html.twig");
	}
});
//route de la page login
router.get("/login.html",function(req,resp){
	
	if(typeof req.user !== 'undefined')
	{
		resp.render("login.html.twig",{"username":req.user.username});
	}
	else
	{
		resp.render("login.html.twig");
	}
});
//route du login après identification
router.post("/login.html",passport.authenticate('local-login',{successRedirect:"/index.html",failureRedirect:"/login.html"}));

//route du logout
router.get("/logout.html",function(req,resp){
	req.logout();
	resp.redirect('index.html');
});

module.exports = router;