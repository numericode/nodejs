var cfg = require('config')
var mysql = require('mysql');

var config =  {
  host     : cfg.DB.dbhost,
  user     : cfg.DB.dbusername,
  database : cfg.DB.dbname,
  password : cfg.DB.dbpwd,
};
 
var connection = connect();

function connect() {
    var connection = mysql.createConnection(config);
    connection.connect(function(err) {
      if(err){
        console.info('Error connecting ' +err);
        errorHandler(err);
      }else{
        console.info('MySql connected to ' + connection.config.host + ':' + connection.config.port);  
      }
    });
    connection.on('error', errorHandler);
    return connection;
}
 
function errorHandler(err) {
    console.info('MySQL error ' + err);
    if (err.code === 'PROTOCOL_CONNECTION_LOST') {
        console.info('MySQL connection lost. Reconnecting.');
        connection = connect();
    } else if (err.code === 'ECONNREFUSED') {
        console.info('MySQL connection refused. Trying again in 3 seconds.');
        setTimeout(function() {
            connection = connect();
        }, 3000);
    }
}
function query() {
    return connection.query.apply(connection,arguments);
}
 
function close() {
    connection.end();
}
 
exports.query = query;
exports.close = close;